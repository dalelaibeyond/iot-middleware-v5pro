# V6800_V1.3.md

*This document full name is: V6800 MQTT Message Format, Parser and Normalizer Guide v1.3*

# Part 1: Overview

This document describes:

- **V6800 IoT Gateway** MQTT message format.
- **V6800Parser.js**: Logic to clean and key-map the raw JSON.
- **UnifyNormalizer.js**: Logic to split the parsed arrays and normalize data into the database.

## **Key Design Principles**

1. **Structure Preservation:** V6800 messages often contain arrays of modules (e.g., one Heartbeat containing data for 5 modules). The Parser **must preserve this array structure**. It should not try to split the message.
2. **Terminology Mapping:**
    - `messageType`: Mapped from the **Topic Suffix** (e.g., "TemHum", "HeartBeat") to match V5008 style.
    - `rawMessageType`: Preserves the original V6800 `msg_type` (e.g., "temper_humidity_exception_nofity_req").
3. **Result Codes:** Standardized to `"Success"` or `"Failure"`.
4. *Parsers must add a `ts`: new Date().toISOString() field to the root of the parsed object.*

## **Common Naming (Standardized Keys)**

- `deviceId` (String): Unique gateway device ID.
- `modId` (String): Module global ID.
- `msgId` (String): Message unique identifier.
- `modAddr` (Integer): Module RS485 address / Port Index.
- `sensorAddr` (Integer): Sensor address.
- `uPos` (Integer): U-level index.
- `tagId` (String): RFID tag ID.
- `action` (String): RFID Event type ("attached", "detached").
- `doorState` (String): "01" (Open), "00" (Close).

# Part 2: MQTT Message Format & Key Map

### MQTT Topic Structure

- **Upload:** `V6800Upload/{deviceId}/{TopicSuffix}`

### **Raw Key Mapping Table**

| Raw V6800 Key | Target Key | Type | Remark |
| --- | --- | --- | --- |
| `msg_type` | `rawMessageType` | String | Original V6800 type string |
| **(Topic Suffix)** | `messageType` | String | Standardized type (e.g., "TemHum") |
| `gateway_sn` | `deviceId` | String |  |
| `uuid_number` | `messageId` | String |  |
| `host_gateway_port_index` | `modAddr` | Int |  |
| `module_index` | `modAddr` | Int |  |
| `extend_module_sn` | `modId` | String |  |
| `module_sn` | `modId` | String |  |
| `u_index` | `uPos` | Int |  |
| `temper_position` | `sensorAddr` | Int |  |
| `temper_swot` | `temp` | Float |  |
| `hygrometer_swot` | `hum` | Float |  |
| `bus_V` | `meta.voltage` | Float |  |
| `bus_I` | `meta.current` | Float |  |

# Part 3: V6800Parser.js Parsing Guide

The Parser input is the raw JSON string and the Topic.
The output is a standardized JSON object. **Note:** Since V6800 messages often contain data for multiple modules, the parser returns a `data` array containing the module-specifics.

### 1. Heartbeat Message (`HEARTBEAT`)

**Topic:** `.../HeartBeat`**Raw Input:**

```json
{
  "msg_type": "heart_beat_req",
  "module_type": "mt_gw",
  "module_sn": "2123456789",
  "bus_V": "23.89",
  "bus_I": "5.70",
  "main_power": 1, "backup_power": 0,
  "uuid_number": 1534195387,
  "data": [
    { "module_index": 2, "module_sn": "3963041727", "module_m_num": 1, "module_u_num": 6 },
    { "module_index": 4, "module_sn": "2349402517", "module_m_num": 2, "module_u_num": 12 }
  ]
}

```

**Parsed Output:**

```json
{
  "topic": "V6800Upload/2123456789/HeartBeat",
  "deviceType": "V6800",
  "deviceId": "2123456789",
  "messageType": "HeartBeat",
  "rawMessageType": "heart_beat_req",
  "messageId": "1534195387",
  "meta": {
    "voltage": 23.89,
    "current": 5.70,
    "mainPower": true,
    "backupPower": false
  },
  "modules": [
    { "modAddr": 2, "modId": "3963041727", "uTotal": 6 },
    { "modAddr": 4, "modId": "2349402517", "uTotal": 12 }
  ]
}

```

---

### 2. RFID Message (`LabelState`)

**Logic:**

- Iterate through the `data` array (Modules).
- Inside each module, iterate through `u_data` (Tags).
- Calculate `action`:
    - If `new_state`=1 & `old_state`=0 → `"attached"`
    - If `new_state`=0 & `old_state`=1 → `"detached"`

**Topic:** `.../LabelState`**Raw Input:**

```json
{
  "msg_type": "u_state_changed_notify_req",
  "gateway_sn": "2123456789",
  "uuid_number": 727046823,
  "data": [
    {
      "host_gateway_port_index": 2,
      "extend_module_sn": "3963041727",
      "u_data": [
        { "u_index": 3, "new_state": 1, "old_state": 0, "tag_code": "DD23B0B4", "warning": 0 },
        { "u_index": 1, "new_state": 0, "old_state": 1, "tag_code": "DD395064", "warning": 0 }
      ]
    }
  ]
}

```

**Parsed Output:**

```json
{
  "topic": "V6800Upload/2123456789/LabelState",
  "deviceType": "V6800",
  "deviceId": "2123456789",
  "messageType": "LabelState",
  "rawMessageType": "u_state_changed_notify_req",
  "messageId": "727046823",
  "data": [
    {
      "modAddr": 2,
      "modId": "3963041727",
      "items": [
        { "uPos": 3, "alarmStatus": 0, "tagId": "DD23B0B4", "action": "attached" },
        { "uPos": 1, "alarmStatus": 0, "tagId": "DD395064", "action": "detached" }
      ]
    }
  ]
}

```

---

### 3. Temperature & Humidity (`TemHum`)

**Topic:** `.../TemHum`**Raw Input:**

```json
{
  "msg_type": "temper_humidity_exception_nofity_req",
  "gateway_sn": "2123456789",
  "uuid_number": 685205293,
  "data": [
    {
      "host_gateway_port_index": 2,
      "extend_module_sn": "3963041727",
      "th_data": [
        { "temper_position": 10, "temper_swot": 28.79, "hygrometer_swot": 53.79 },
        { "temper_position": 12, "temper_swot": 0, "hygrometer_swot": 0 }
      ]
    }
  ]
}

```

**Parsed Output:**

```json
{
  "topic": "V6800Upload/2123456789/TemHum",
  "deviceType": "V6800",
  "deviceId": "2123456789",
  "messageType": "TemHum",
  "rawMessageType": "temper_humidity_exception_nofity_req",
  "messageId": "685205293",
  "data": [
    {
      "modAddr": 2,
      "modId": "3963041727",
      "sensors": [
        { "sensorAddr": 10, "temp": 28.79, "hum": 53.79 },
        { "sensorAddr": 12, "temp": 0, "hum": 0 } // Or null, depending on policy
      ]
    }
  ]
}

```

---

### 4. Door Status Change (`Door`)

**Topic:** `.../Door`**Raw Input:**

```json
{
  "msg_type": "door_state_changed_notify_req",
  "gateway_sn": "2123456789",
  "uuid_number": 333321551,
  "data": [
    { "extend_module_sn": "3963041727", "host_gateway_port_index": 2, "new_state": 1 }
  ]
}

```

**Parsed Output:**

```json
{
  "topic": "V6800Upload/2123456789/Door",
  "deviceType": "V6800",
  "deviceId": "2123456789",
  "messageType": "Door",
  "rawMessageType": "door_state_changed_notify_req",
  "messageId": "333321551",
  "data": [
    {
      "modAddr": 2,
      "modId": "3963041727",
      "doorState": "01"
    }
  ]
}

```

---

### 5. Device Init / Info (`Init`)

**Logic:** Separate the root Gateway info from the Module list.

**Topic:** `.../Init`**Raw Input:**

```json
{
  "msg_type": "devies_init_req",
  "gateway_sn": "2123456789",
  "gateway_ip": "192.168.0.212", "gateway_mac": "08:80:7E:...",
  "uuid_number": 797991388,
  "data": [
    { "module_index": 2, "module_sn": "3963041727", "module_u_num": 6, "module_sw_version": "2307101644" }
  ]
}

```

**Parsed Output:**

```json
{
  "topic": "V6800Upload/2123456789/Init",
  "deviceType": "V6800",
  "deviceId": "2123456789",
  "messageType": "Init",
  "rawMessageType": "devies_init_req",
  "messageId": "797991388",
  "device": {
    "ip": "192.168.0.212",
    "mac": "08:80:7E:..."
  },
  "modules": [
    { "modAddr": 2, "modId": "3963041727", "uTotal": 6, "fwVer": "2307101644" }
  ]
}

```

---

### 6. Query RFID Response (`LabelState`)

**Logic:** Handle null tags properly.

**Topic:** `.../LabelState`**Raw Input:**

```json
{
  "msg_type": "u_state_resp",
  "code": 200,
  "gateway_sn": "2123456789",
  "uuid_number": 423018504,
  "data": [{
      "host_gateway_port_index": 4, "extend_module_sn": "2349402517",
      "u_data": [
        { "u_index": 4, "u_state": 0, "tag_code": null },
        { "u_index": 3, "u_state": 1, "tag_code": "DD344A44" }
      ]
  }]
}

```

**Parsed Output:**

```json
{
  "topic": "V6800Upload/2123456789/LabelState",
  "deviceType": "V6800",
  "deviceId": "2123456789",
  "messageType": "LabelState",
  "rawMessageType": "u_state_resp",
  "messageId": "423018504",
  "data": [
    {
      "modAddr": 4,
      "modId": "2349402517",
      "items": [
        { "uPos": 4, "alarmStatus": 0, "tagId": null },
        { "uPos": 3, "alarmStatus": 0, "tagId": "DD344A44" }
      ]
    }
  ]
}

```

---

### 7. Query U-Level Color Response (`OpeAck`)

**Topic:** `.../OpeAck`**Raw Input:**

```json
{
  "msg_type": "u_color",
  "gateway_id": "2123456789",
  "code": 1346589,
  "uuid_number": 82941514,
  "data": [
    {
      "index": 2, "module_id": "3963041727", "u_num": 6,
      "color_data": [
        { "index": 1, "code": 13 },
        { "index": 2, "code": 0 }
      ]
    }
  ]
}

```

**Parsed Output:**

```json
{
  "topic": "V6800Upload/2123456789/OpeAck",
  "deviceType": "V6800",
  "deviceId": "2123456789",
  "messageType": "OpeAck",
  "rawMessageType": "u_color",
  "messageId": "82941514",
  "data": [
    {
      "modAddr": 2,
      "modId": "3963041727",
      "colorMap": [13, 0]
    }
  ]
}

```

---

### 8. Set U-level Color Response (`OpeAck`)

**Logic:** `set_property_result` (0=Success, 1=Failure).

**Topic:** `.../OpeAck`**Raw Input:**

```json
{
  "msg_type": "set_module_property_result_req",
  "gateway_sn": "2123456789",
  "uuid_number": 245761302,
  "data": [
    { "host_gateway_port_index": 2, "extend_module_sn": "3963041727", "set_property_result": 0 },
    { "host_gateway_port_index": 4, "extend_module_sn": "2349402517", "set_property_result": 0 }
  ]
}

```

**Parsed Output:**

```json
{
  "topic": "V6800Upload/2123456789/OpeAck",
  "deviceType": "V6800",
  "deviceId": "2123456789",
  "messageType": "OpeAck",
  "rawMessageType": "set_module_property_result_req",
  "messageId": "245761302",
  "data": [
    {
      "modAddr": 2,
      "modId": "3963041727",
      "result": "Success"
    },
    {
      "modAddr": 4,
      "modId": "2349402517",
      "result": "Success"
    }
  ]
}

```

---

### 9. Clear Alarm Response (`OpeAck`)

**Logic:** `ctr_flag` (true=Success, false=Failure).

**Topic:** `.../OpeAck`**Raw Input:**

```json
{
  "msg_type": "clear_u_warning",
  "gateway_id": "2123456789",
  "uuid_number": 775199553,
  "data": [
    { "index": 2, "module_id": "3963041727", "ctr_flag": true }
  ]
}

```

**Parsed Output:**

```json
{
  "topic": "V6800Upload/2123456789/OpeAck",
  "deviceType": "V6800",
  "deviceId": "2123456789",
  "messageType": "OpeAck",
  "rawMessageType": "clear_u_warning",
  "messageId": "775199553",
  "data": [
    {
      "modAddr": 2,
      "modId": "3963041727",
      "result": "Success"
    }
  ]
}

```

# Part 4: UnifyNormalizer.js Guide (V6800 Specific)

The Normalizer receives the **Parsed Output**. Because V6800 messages are often arrays (`data` list), the Normalizer **must** iterate through the `data` array in the parsed JSON.

### 1. Loop Strategy

Unlike V5008 (which is usually single-module per message), V6800 requires a double loop:

1. **Loop 1:** Iterate through `parsedJson.data` (The Modules).
2. **Loop 2:** Iterate through `module.items` (RFID) or `module.sensors` (Temp/Hum).

### 2. Handling RFID "Actions"

The Parser has already calculated `action: "attached"` or `"detached"`.

- **Normalizer Logic:**
    - Store the event in the **Events Table** (Log history).
    - Update the **Current State Table** (The Rack Map).

### 3. Handling Init (Split Strategy)

The Parser returns a combined object. The Normalizer must split it:

1. **Update Gateway Info:** Use `parsedJson.device` (IP, MAC).
2. **Update Module Info:** Iterate `parsedJson.modules` and update the connected modules table.