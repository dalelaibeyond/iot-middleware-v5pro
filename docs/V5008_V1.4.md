# V5008_V1.4.md

*This document full name is : V5008 MQTT Message Format, Parser and Normalizer Guide v1.4* 

# **Part 1: Overview**

This document describes :

- V5008 IoT device MQTT message format
- Guide the implementation of **V5008Parser.js** to parse raw binary messages into JSON format.
- Guide the implementation of **UnifyNormalizer.js** to normalize device-specific parsed message into unified and normalized message for storage and indexing. ****

The V5008 IoT Gateway device acts as both a **Publisher** and **Subscriber**. The device sends **Binary Buffers**. Hex strings in this document are for representation only.

The Parser must look at the **Binary Header** (e.g., `0xCC` vs `0xBA`) to determine the `messageType` output (e.g., `HEARTBEAT` vs `DOOR_STATE`), rather than relying solely on the topic suffix.

*Parsers must add a `ts`: new Date().toISOString() field to the root of the parsed object.*

 Ensure both parsers output `modId` as a **String**. V5008 parser must convert the uint32 to a string to ensure strict equality checks in the Normalizer.

## **Common Naming and Field Definitions**

- `deviceId`(4-byte): Unique gateway device ID.
- `modId`(4-byte): Module global ID.
- `messageId` (4-byte): Random message identifier (all responses end with this).
- `modAddr` (1-byte): Module Modbus/RS485 address (Valid: 1-5).
- `sensorAddr` (1-byte): Sensor Modbus/RS485 address.
- `uPos` (1-byte): U-level index (Range: 1–54).
- `uTotal` (1-byte): Total installed U-levels (Range: 1-54).
- `onlineCount` (1-byte): Count of active RFID tags on the U-level.
- `alarmStatus` (1-byte): Indicates if an alarm is active at the U-level (00: Normal, 01: Alarm).
- `tagId` (4-byte): RFID tag ID.
- `doorState` (1-byte): Indicates rack door status (00: Close, 01: Open).
- `resultCode` (1-byte): Indicates set or query command success or fail (A1: Success, A0: Failure).
- `reserved` (1-byte): unused
- `colorCode` (1-byte): a color code to indicate the color, refer to section: *Color Code*
- `originalReq` ( n-byte): query or set command hex string, refer to section: *Download Message Quick References*

# Part 2: **Physical Device Topology**

To normalize data correctly, developers must understand the physical hierarchy of the V5008 Gateway:

1. **Level 1: Gateway (The Device)**
    - Identified by `deviceId`. Connects via MQTT.
2. **Level 2: Module (The Expansion Bar)**
    - Identified by `modAddr` (1-5).
    - Connects to Gateway via Modbus.
3. **Level 3: Sensors (The Data Points)**
    - Sensors are children of a Module.
    - **U-Level Tags:** Indexed by `uPos` (1-54).
    - **TH Sensors:** Indexed by `sensorAddr` (10-15).
    - **Noise Sensors:** Indexed by `sensorAddr` (16-18).
    - **Door:** One per Module.

*Note: The UnifyNormalizer must flatten this hierarchy into a searchable format: `Gateway -> Module -> SensorIndex.`*

**2.1 Normalization Strategy Requirements**

- **Hybrid Storage Model:** Telemetry data (Temperature, Humidity, Noise) must be split into individual rows for SQL analytics. Complex state data (RFID Maps) must be stored as JSON blobs to preserve snapshot integrity.
- **Hierarchy Indexing:** The database schema must include `module_index` and `sensor_index` columns. These values must be extracted during normalization and not buried inside JSON payloads.

# Part 3: **MQTT Message Format**

### MQTT Topic Structure

- **Download Topics (Server to Device):** `V5008Download/{deviceId}`
- **Upload Topics (Device to Server):** `V5008Upload/{deviceId}/{messageType}`

### Global Message Structure

- **Data Type:** The device sends **Binary Buffers**. Hex strings in this document are for representation only.
- **Endianness:** Big-Endian for multi-byte integers unless specified.
- **Default Size:** 1 byte unless specified (e.g., `varName(4B)` denotes 4 bytes).
- **Structure Notation:** `(fieldA + fieldB) x count` indicates a repeating loop.
- **Values:** Temperature/Humidity/Noise use a split `Integer` + `Fraction` byte format.

### Message Identification Reference

| Priority | Identification Method | Value / Pattern | Meaning |
| --- | --- | --- | --- |
| 1 | MQTT Topic Suffix | `OpeAck` | Control / ACK / Query Response |
|  |  | `LabelState` | RFID / U-level related |
|  |  | `TemHum` | Temperature & Humidity |
|  |  | `Noise` | Noise sensor |
| 2 | First Byte (Header) | `CC` / `CB` | HEARTBEAT |
|  |  | `BB` | RFID Event / Query Response |
|  |  | `BA` | Door State |
|  |  | `AA` | Set / Query Color / Clear Alarm ACK |
|  |  | `EF01` | Device Info Response |
|  |  | `EF02` | Module Info Response |
| 3 | Payload Length | Fixed / Variable | Used only when header overlaps |

notes: Parser should determine message type primarily by MQTT topic, then validate using header bytes. Payload length is a fallback only.

### **Value Constants**

| Field | Hex | Meaning |
| --- | --- | --- |
| alarmStatus | `00` | Normal |
|  | `01` | Alarm |
| doorState | `00` | Closed |
|  | `01` | Open |
| resultCode | `A1` | Success |
|  | `A0` | Failure |

### Color Code

| Color Code | Color Name | Color Code | Color Name(flash color) |
| --- | --- | --- | --- |
| 00 | Off |  |  |
| 01 | red | 08 | red_f |
| 02 | purple | 09 | purple_f |
| 03 | yellow | 0A | yellow_f |
| 04 | green | 0B | green_f |
| 05 | cyan | 0C | cyan_f |
| 06 | blue | 0D | blue_f |
| 07 | white | 0E (not recommended) | white_f |

### Parser Behaviour Notes

- If message length is shorter than required by the declared format, the parser **must discard the message**.
- Unknown header values **must not crash** the parser; log and ignore.
- All multi-byte numeric fields are **Big-Endian**.
- Fields with all-zero values in fixed arrays indicate **unused slots**.
- `messageId` is always the **last 4 bytes** of the packet.

### Upload Message Quick References

| Sensor Type  | Message Type  | Upload Topic  | Header (Hex) | Message Description | Binary Message Format | Remark |
| --- | --- | --- | --- | --- | --- | --- |
| `DEVICE` | `HEARTBEAT` | `V5008Upload/{deviceId}/OpeAck` | `CC|CB` | Device heartbeat signal | [CC|CB] + (modAddr + modId + uTotal) × 10 + messageId | *Fixed Array: 10 slots. Protocol supports addresses 1-10, but current hardware only uses 1-5. Ignore slots > 5.* |
| `U_SENSOR`  | `RFID` | `V5008Upload/{deviceId}/LabelState` | `BB` | RFID tag detection events | [BB] + modAddr + modId + reserved + uTotal + onlineCount + (uPos + alarmStatus + tagId) × onlineCount + messageId |  |
| `TH_SENSOR` | `TEMP_HUM` | `V5008Upload/{deviceId}/TemHum` | **None** | Temperature and humidity readings | modAddr + modId + (sensorAddr + tempInt + tempFrac + humInt + humFrac) × 6 + messageId | **Fixed Array:** Always 6 sensor slots, sensorAddr valid from 0x0A-0x0F. Unused slots TH value are 0x00. |
| `NS_SENSOR` | `NOISE` | `V5008Upload/{deviceId}/Noise` | **None** | Noise level measurements | modAddr + modId + (sensorAddr + noiseInt + noiseFrac) x 3 + messageId | **Fixed Array:** Always 3 sensor slots, sensorAddr valid from 0x10-0x12. Unused slots noise value are 0x00. |
| `DR_SENSOR` | `DOOR_STATE` | `V5008Upload/{deviceId}/OpeAck` | `BA` | Door open/close events | [BA] + modAddr + modId + doorState + messageId |  |
| `U_SENSOR` | `QRY_RFID_RESP` | `V5008Upload/{deviceId}/LabelState` |  | RFID query response | refer to  `RFID` |  |
| `TH_SENSOR` | `QRY_TEMP_HUM_RESP` | `V5008Upload/{deviceId}/TemHum` |  | Temperature/humidity query response | refer to `TEMP_HUM` |  |
| `NS_SENSOR` | `QRY_NOISE_RESP` | `V5008Upload/{deviceId}/Noise` |  | Noise level query response | refer to  `NOISE` |  |
| `DR_SENSOR` | `QRY_DOOR_STATE_RESP` | `V5008Upload/{deviceId}/OpeAck` |  | Door state query response | refer to  `DOOR_STATE` |  |
| `DEVICE` | `QRY_DEVICE_RESP` | `V5008Upload/{deviceId}/OpeAck` | `EF01` | Device info query response | [EF01]+[1390]+fwVer(4B) + ip(4B)+ mask(4B) + gatewayIp(4B) + mac(6B) + messageId |  |
| `MODULE` | `QRY_MODULE_RESP` | `V5008Upload/{deviceId}/OpeAck` | `EF02` | Module info query response | [EF02] + ((modAddr + fwVer(4B) ) x N + messageId | N = (Total_Packet_Bytes - 6) / 5 |
| `U_SENSOR` | `QRY_COLOR_RESP` | `V5008Upload/{deviceId}/OpeAck` | `AA` | U-level light  color query response | [AA] + deviceId+ resultCode + originalReq + colorCode x uTotal + messageId | uTotal = Total_Packet_Bytes - 12*(Derived from: 1(AA) + 4(DevId) + 1(Result) + 2(OrigReq) + 4(*messageId*) = 12 bytes)* |
| `U_SENSOR` | `SET_COLOR_RESP` | `V5008Upload/{deviceId}/OpeAck`  | `AA` | U-level light color set response | [AA] + deviceId+ resultCode + originalReq + messageId | **Variable Length:** originalReq length = TotalBytes - 10. originalReq includes command code: **`E1`** |
| `U_SENSOR` | `CLR_ALARM_RESP` | `V5008Upload/{deviceId}/OpeAck` | `AA` | U-level alarm clear response | [AA] + deviceId + resultCode + originalReq + messageId | **Variable Length:** originalReq length = TotalBytes - 10. originalReq includes command code:  **`E2`** |

### Download Message Quick References

| Message Description | Binary Message Format | Remark | Device Response | originalReq Echoed |
| --- | --- | --- | --- | --- |
| Query RFID  | [E901] + modAddr | Fixed Length |  `RFID` | No |
| Query Temperature/Humidity  | [E902] + modAddr | Fixed Length |  `TEMP_HUM` | No |
| Query Door State  | [E903] + modAddr | Fixed Length |  `DOOR_STATE` | No |
| Query Noise Level  | [E904] + modAddr | Fixed Length | `NOISE` | No |
| Query Device Information | [EF0100] | Fixed Length |  `QRY_DEVICE_RESP` | No |
| Query Module Information | [EF0200] | Fixed Length |  `QRY_MODULE_RESP` | No |
| Set U-level Light Color | [E1] + modAddr + (uPos + colorCode) × N | Variable Length | `SET_COLOR_RESP` | Yes |
| Query U-level Light Color | [E4] + modAddr | Fixed Length | `QRY_COLOR_RESP` | Yes |
| Clear U-level Tamper Alarm | [E2] + modAddr + uPos | Fixed Length |  `CLR_ALARM_RESP` | Yes |

# Part 4: **V5008Parser.js Parsing Guide (JSON Parsing Examples)**

### Heartbeat Message (`HEARTBEAT`)

(Real topic and message inserted)

```json
{
  topic: "V5008Upload/2437871205/OpeAck",
  message:"CC01EC3737BF06028C0909950C0300000000000400000000000500000000000600000000000700000000000800000000000900000000000A0000000000F200168F",
  deviceType: "V5008",
  deviceId: "2437871205",
  messageType: "OpeAck",
  messageId:"4060092047",

  modules: [
    { modAddr: 1, modId: "3963041727", uTotal: 6 },
    { modAddr: 2, modId: "2349402517", uTotal: 12 }
  ]
}

// Note: Ignore slots where modAddr is 0 or outside the valid range (1-5).
```

---

### RFID Message (`RFID`)

```json
{
  topic: "V5008Upload/2437871205/LabelState",
  message: "BB028C090995000C030A00DD344A440B00DD2862B40C00DD3CE9C4050007AD",
  deviceType: "V5008",
  deviceId: "2437871205",
  messageType: "LabelState",
  messageId: "83891437",

  modAddr: 2,
  modId: "2349402517",
  uTotal: 12,
  onlineCount: 3,

  items: [
    { uPos: 10, alarmStatus: 0, tagId: "DD344A44" },
    { uPos: 11, alarmStatus: 0, tagId: "DD2862B4" },
    { uPos: 12, alarmStatus: 0, tagId: "DD3CE9C4" }
  ]
}
```

---

### Temperature & Humidity message (`TEMP_HUM`)

```json
{
  topic: "V5008Upload/2437871205/TemHum",
  message: "01EC3737BF0A1C30331B0B1C08330B0C000000000D000000000E000000000F0000000001012CC3",
  deviceType: "V5008",
  deviceId: "2437871205",
  messageType: "TemHum",
  messageId: "16846659",

  modAddr: 1,
  modId: "3963041727",

  sensors: [
    { sensorAddr: 10, temp: 28.48, hum: 51.27 },
    { sensorAddr: 11, temp: 28.08, hum: 51.11 },
    { sensorAddr: 12, temp: null, hum: null },
    { sensorAddr: 13, temp: null, hum: null },
    { sensorAddr: 14, temp: null, hum: null },
    { sensorAddr: 15, temp: null, hum: null }
  ]
}
```

---

### Door State Message (`DOOR_STATE`)

```json
{
  topic: "V5008Upload/2437871205/OpeAck",
  message: "BA01EC3737BF010B01C7F8",
  deviceType: "V5008",
  deviceId: "2437871205",
  messageType: "OpeAck",
  messageId: "184666104",

  modAddr: 1,
  modId: "3963041727",
  doorState: "01"
}
```

---

### U-level Light Color Set Response Message (`SET_COLOR_RESP`)

```json
{
  topic: "V5008Upload/2437871205/OpeAck",
  message: "AA914EF665A1E101050206012B002316",
  deviceType: "V5008",
  deviceId: "2437871205",
  messageType: "OpeAck",
  messageId: "721420310",

  result: "Success",
  originalReq: "E10105020601"
}
```

---

### U-level Light Color Query Response Message (`QRY_COLOR_RESP`)

```json
{
  topic: "V5008Upload/2437871205/OpeAck",
  message: "AA914EF665A1E4010000000D0D0825015D4C",
  deviceType: "V5008",
  deviceId: "2437871205",
  messageType: "OpeAck",
  messageId: "620846412",

  result: "Success",
  originalReq: "E401",

  colorMap: [0, 0, 0, 13,13,8]
}

```

---

### U-level Alarm Clear Response Message (`CLR_ALARM_RESP`)

```json
{
  topic: "V5008Upload/2437871205/OpeAck",
  message: "AA914EF665A1E2010605AC009ECF",
  deviceType: "V5008",
  deviceId: "2437871205",
  messageType: "OpeAck",
  messageId: "2885745871",

  result: "Success",
  originalReq: "E2010605"
}
```

---

### Device Info Query Response Message (`QRY_DEVICE_RESP`)

```json
{
  topic: "V5008Upload/2437871205/OpeAck",
  message: "EF011390958DD85FC0A800D3FFFF0000C0A800018082914EF665F2011CCB",
  deviceType: "V5008",
  deviceId: "2437871205",
  messageType: "OpeAck",
  messageId: "4060159179",

  model: "1390",
  fwVer: "2509101151",
  ip: "192.168.0.211",
  mask: "255.255.0.0",
  gatewayIp: "192.168.0.1",
  mac: "80:82:91:4E:F6:65"
}
```

---

### Module Info Query Response message (`QRY_MODULE_RESP`)

```json
{
  topic: "V5008Upload/2437871205/OpeAck",
  message: "EF0201898393CC02898393CCF4010166",
  deviceType: "V5008",
  deviceId: "2437871205",
  messageType: "OpeAck",
  messageId: "4093706598",

  modules: [
    { modAddr: 1, fwVer: "2307101644" },
    { modAddr: 2, fwVer: "2307101644" }
  ]
}
```

---

### Noise Message (`NOISE` )

```json
{
  topic: "V5008Upload/2437871205/Noise",
  message: "01EC3737BF100000000011000000001200000000D500EBD7",
  deviceType: "V5008",
  deviceId: "2437871205",
  messageType: "Noise",
  messageId: "3573607383",

  modAddr: 1,
  modId: "3963041727",

  sensors: [
    { sensorAddr: 16, noise: null },
    { sensorAddr: 17, noise: null },
    { sensorAddr: 18, noise: null }
  ]
}

```

# Part 5: **Developer Implementation Notes**

### 1) Convert Raw Binary Message to Hex String

```jsx
const hexString = message.toString("hex").toUpperCase();
```

### 2) Parsing QRY_COLOR_RESP (Missing Count Field)

The QRY_COLOR response does not contain a count field (uTotal). The parser must calculate how many colors are in the list based on the packet length.

- **Assumption:** originalReq is exactly 2 bytes in this specific message.
- **Logic:**

```jsx
// Total Bytes - Header(1) - DevId(4) - Result(1) - OrigReq(2) - messageId(4)
const fixedOverhead = 12; 
const uTotal = messageBuffer.length - fixedOverhead;

// Then loop 'uTotal' times to read the colors
```

### 3) Parsing Variable Length originalReq

For SET_COLOR_RESP and CLR_ALARM_RESP, the originalReq echoes the request, which varies in length.

- **Logic:**

```jsx
// Header(1) + DevId(4) + Result(1) = 6 bytes at start
// messageId(4) = 4 bytes at end
const reqLength = messageBuffer.length - 10;

// Read buffer from index 6 with length 'reqLength'
const originalReq = messageBuffer.subarray(6, 6 + reqLength);
```

### 4) Temperature/Noise Decimal Conversion

Values are split into Integer and Fraction bytes.

- **Format:** [IntByte] [FracByte]
- **Logic:**
    - IntByte is a **Signed** 8-bit Integer (can be negative).
    - FracByte is an **Unsigned** 8-bit Integer (0-99).
- **Formula:**

```jsx
// Javascript Example
const intPart = buffer.readInt8(offset);
const fracPart = buffer.readUInt8(offset + 1);

// Handle negative numbers correctly (e.g. -5 and 50 should be -5.50)
let value = Math.abs(intPart) + (fracPart / 100.0);
if (intPart < 0) value = value * -1;
```

### 5) Heartbeat & Sensor Arrays (Fixed Padding)

- **HEARTBEAT**: If **modAddr === 0** (or if modId is all zeros), ignore.
- **TEMP_HUM**: Always reads 6 items. If **sensorAddr === 0**, ignore the item (or set to null).
- **NOISE**: Always reads 3 items. If **sensorAddr === 0**, ignore the item.

# **Part 6: UnifyNormalizer.js Guide**

### **Recommended Database Table Structure**

```sql
CREATE TABLE iot_unified_data (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    
    -- 1. Identity (The "Who")
    device_id VARCHAR(32) NOT NULL,        -- Gateway ID (e.g., "2437871205")
    device_type VARCHAR(10) NOT NULL,      -- "V5008", "V6800"
    
    -- 2. Physical Hierarchy (The "Where" - crucial for your query logic)
    module_index INT DEFAULT 0,            -- V5008 modAddr (1-5). 0 if not applicable.
    sensor_index INT DEFAULT 0,            -- The "Grain". 
                                           -- For Temp: sensorAddr (10-15). 
                                           -- For U-Level: uPos (1-54).
                                           -- For Noise: sensorAddr (16-18).
    
    -- 3. Classification (The "What")
    message_class VARCHAR(20) NOT NULL,    -- "TELEMETRY", "EVENT", "STATE", "ALARM"
    data_key VARCHAR(32) NOT NULL,         -- "temperature", "humidity", "noise", "door", "rfid_map"
    
    -- 4. The Value (Hybrid Approach)
    num_value DOUBLE,                      -- For aggregations (Temp, Hum, Noise, Battery)
    str_value VARCHAR(255),                -- For simple states ("OPEN", "CLOSED", TagID)
    json_value JSON,                       -- For complex maps (Full RFID list, Raw Meta)
    
    -- 5. Time
    ts_device DATETIME(3),                 -- When the sensor actually read the data
    ts_server DATETIME(3) DEFAULT NOW()    -- When it hit your DB
);

-- INDEXING STRATEGY (Critical for performance)
-- CREATE INDEX idx_search ON iot_unified_data (device_id, module_index, data_key, ts_device);
```

### How V5008 maps to this table:

**Case A: Temperature Message (Splitting the Array)**

*The Normalizer receives one TEMP_HUM message with 6 sensors. It emits **12 DB rows** (6 temp + 6 hum).*

- `device_id`: "2437871205"
- `module_index`: 1
- `sensor_index`: 10
- `message_class`: "TELEMETRY"
- `data_key`: "temperature"
- `num_value`: 24.5
- `json_value`: NULL

**Case B: RFID Message (Preserving the Snapshot)**

*The Normalizer receives one RFID message. It emits **1 DB row**.*

- `device_id`: "2437871205"
- `module_index`: 1
- `sensor_index`: 0 (Applies to whole module)
- `message_class`: "STATE"
- `data_key`: "rfid_full_map"
- `num_value`: NULL
- `json_value`:  `[{ "uPos": 1, "tagId": "ABC" }, { "uPos": 2, "tagId": "XYZ" }]`

**Case C: Door Event**

- `device_id`: "2437871205"
- `module_index`: 1
- `sensor_index`: 0 (Door is per module)
- `data_key`: "door_state"
- `num_value`: 1 (Open)

### **The UnifyNormalizer.js Structure**

To support the database structure above, your JS object in memory needs to handle the "Explosion" (Splitting) before it hits the DB.

**Refined JSON Object (Output of Normalizer):**

```jsx
// The Normalizer should return an ARRAY of these objects.
// If a V5008 Temp packet comes in, return 12 of these objects.
[
  {
    "identity": {
      "deviceId": "2437871205",
      "deviceType": "V5008",
      "moduleIndex": 1,       // modAddr
      "sensorIndex": 10       // sensorAddr or uPos
    },
    "context": {
      "category": "TELEMETRY", // or EVENT, STATE
      "key": "temperature"     // Standardized Key
    },
    "value": {
      "numeric": 28.48,
      "string": null,
      "raw": { ...meta... }
    },
    "ts": "2025-11-13T07:04:52.951Z"
  }
]
```